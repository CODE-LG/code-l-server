name: CD - Docker Hub Deploy to Dev

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Grant permission to gradlew
        run: chmod +x ./gradlew

      - name: Generate application.yml
        run: |
          mkdir -p src/main/resources
          cat <<EOF > src/main/resources/application.yml
          server:
            port: 8080
          security:
            jwt:
              token:
                expire-length: ${{ secrets.JWT_EXPIRE_LENGTH }}
                secret-key: ${{ secrets.JWT_SECRET_KEY }}
            admin:
              password: ${{ secrets.ADMIN_PASSWORD }}
          cloud:
            aws:
              region:
                static: ap-northeast-2
              s3:
                bucket: code-l-bucket
              credentials:
                access-key: ${{ secrets.DEV_S3_ACCESS_KEY }}
                secret-key: ${{ secrets.DEV_S3_SECRET_KEY }}
          management:
            endpoints:
              web:
                exposure:
                  include: health, metrics, prometheus
            metrics:
              enable:
                all: true
                processor : false
          spring:
            datasource:
              driver-class-name: com.mysql.cj.jdbc.Driver
              url: jdbc:mysql://codel-db.cbu0ugiswpor.ap-northeast-2.rds.amazonaws.com:3306/codel
              username: ${{ secrets.DEV_RDS_USER_NAME }}
              password: ${{ secrets.DEV_RDS_USER_PASSWORD }}
          
            jpa:
              open-in-view: false
              hibernate:
                ddl-auto: validate
              show-sql: true
              database-platform: org.hibernate.dialect.MySQL8Dialect
          
          discord:
            webhook:
              url: ${{ secrets.DEV_DISCORD_WEBHOOK_URL }}
          
          springdoc:
            override-with-generic-response: false
          EOF

      - name: Generate application.yml for test
        run: |
          mkdir -p src/test/resources
          cat <<EOF > src/test/resources/application.yml
          server:
            port: 8080
          
          security:
            jwt:
              token:
                expire-length: 3600000
                secret-key: dummy-secret-key-should-be-long-enough-123456
            admin:
              password: dummy-admin-password
          
          cloud:
            aws:
              region:
                static: ap-northeast-2
              s3:
                bucket: dummy-code-l-bucket
              credentials:
                access-key: dummy-access-key
                secret-key: dummy-secret-key
          
          management:
            endpoints:
              web:
                exposure:
                  include: health, metrics, prometheus
            metrics:
              enable:
                all: true
          
          spring:
            datasource:
              driver-class-name: org.h2.Driver
              url: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE;MODE=MySQL
              username: sa
              password:
          
            jpa:
              open-in-view: false
              hibernate:
                ddl-auto: create-drop
              show-sql: true
              database-platform: org.hibernate.dialect.H2Dialect
          
          springdoc:
            override-with-generic-response: false
          
          logging:
            level:
              org.hibernate.SQL: debug
              org.hibernate.type.descriptor.sql.BasicBinder: trace

      - name: Restore firebase-adminsdk.json
        run: |
          echo "$FIREBASE_CONFIG_JSON" > ./src/main/resources/code-l-b109b-firebase-adminsdk-fbsvc-8c4eb2e6f2.json
        env:
          FIREBASE_CONFIG_JSON: ${{ secrets.FIREBASE_CONFIG_JSON }}

      - name: Build jar
        run: ./gradlew clean build -x test

      - name: Build Docker image
        run: sudo docker build -t ${{ secrets.DOCKER_USERNAME }}/codel-app:latest .

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | sudo docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

      - name: Push image to Docker Hub
        run: sudo docker push ${{ secrets.DOCKER_USERNAME }}/codel-app:latest

      - name: Prepare and run container locally (self-hosted)
        run: |
          echo "üìÅ Creating log directory..."
          sudo mkdir -p /var/log/app
          sudo chown $USER:$USER /var/log/app

          echo "üßº Cleaning up old container..."
          sudo docker stop codel || true
          sudo docker rm codel || true

          echo "üê≥ Pulling latest image from Docker Hub..."
          sudo docker pull ${{ secrets.DOCKER_USERNAME }}/codel-app:latest

          echo "üöÄ Starting container..."
          sudo docker run -d --name codel -p 8080:8080 -v /var/log/app:/var/log/app -e JAVA_OPTS="-XX:+UnlockExperimentalVMOptions -XX:-UseContainerSupport" ${{ secrets.DOCKER_USERNAME }}/codel-app:latest

          echo "üìÑ Tail log output:"
          sudo docker logs --tail=20 codel || true
