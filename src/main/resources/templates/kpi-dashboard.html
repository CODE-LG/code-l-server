<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPI ëŒ€ì‹œë³´ë“œ - CODE-L ê´€ë¦¬ì</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f5f5f5; 
        }

        /* ì‚¬ì´ë“œë°” */
        .sidebar { 
            position: fixed; 
            left: 0; 
            top: 0; 
            width: 250px; 
            height: 100vh; 
            background: #343a40; 
            padding: 20px; 
            overflow-y: auto; 
            z-index: 1000;
        }
        .sidebar .brand { 
            color: white; 
            font-size: 20px; 
            font-weight: bold; 
            margin-bottom: 30px; 
            display: block; 
            text-decoration: none; 
        }
        .sidebar .nav-item { margin-bottom: 10px; }
        .sidebar .nav-link { 
            display: block; 
            padding: 12px 15px; 
            color: #fff; 
            text-decoration: none; 
            border-radius: 5px; 
            transition: all 0.3s; 
        }
        .sidebar .nav-link:hover { background: #495057; }
        .sidebar .nav-link.active { background: #495057; font-weight: 600; }
        .sidebar .nav-link i { margin-right: 10px; width: 20px; }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content { 
            margin-left: 250px; 
            padding: 30px; 
        }
        .container { 
            max-width: 1600px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        h1 { 
            color: #333; 
            margin-bottom: 10px; 
            font-size: 28px;
        }
        .page-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
            line-height: 1.6;
        }

        /* 0ï¸âƒ£ ë‚ ì§œ ì»¨íŠ¸ë¡¤ ì˜ì—­ */
        .date-control-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            color: white;
        }
        .date-control-section h2 {
            font-size: 16px;
            margin-bottom: 20px;
            opacity: 0.95;
        }
        .date-control-form {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .date-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .date-input-group input {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }
        .date-input-group span {
            font-weight: 600;
        }
        .quick-date-buttons {
            display: flex;
            gap: 8px;
        }
        .quick-date-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        .quick-date-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .quick-date-btn.active {
            background: white;
            color: #667eea;
            font-weight: 600;
        }
        .apply-btn {
            padding: 10px 30px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .apply-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* ì„¹ì…˜ íƒ€ì´í‹€ */
        .section-title {
            font-size: 20px;
            color: #333;
            margin: 40px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            font-weight: 600;
        }

        /* KPI ì¹´ë“œ ê³µí†µ */
        .kpi-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        .kpi-card h3 {
            font-size: 13px;
            color: #666;
            margin-bottom: 12px;
            font-weight: 500;
        }
        .kpi-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        .kpi-card .subtitle {
            font-size: 12px;
            color: #999;
        }

        /* ì°¨íŠ¸ ì„¹ì…˜ */
        .chart-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        .chart-section h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chart-section h2 i {
            color: #667eea;
        }
        .chart-container {
            position: relative;
            height: 350px;
        }
        .chart-container.small {
            height: 280px;
        }

        /* 2. ì‹œê·¸ë„ KPI */
        .kpi-card.signal-sent { border-left-color: #fa7c91; }
        .kpi-card.signal-accepted { border-left-color: #4facfe; }
        .kpi-card.signal-rate { border-left-color: #f093fb; }

        /* 3. ì±„íŒ… KPI */
        .kpi-card.chat { border-left-color: #667eea; }
        .kpi-card.chat-metric { border-left-color: #43e97b; }

        /* ì±„íŒ… í¼ë„ */
        .chat-funnel {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .funnel-title {
            text-align: center;
            font-size: 16px;
            color: #333;
            margin-bottom: 25px;
            font-weight: 600;
        }
        .funnel-step {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        }
        .funnel-step:last-child {
            margin-bottom: 0;
        }
        .funnel-step .step-name {
            font-weight: 600;
            color: #333;
            font-size: 15px;
        }
        .funnel-step .step-value {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .funnel-step .step-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .funnel-step .step-percent {
            font-size: 14px;
            color: #666;
        }
        .funnel-arrow {
            text-align: center;
            color: #999;
            font-size: 16px;
            margin: 5px 0;
            font-weight: 600;
        }

        /* í‰ê·  ë©”ì‹œì§€ ìˆ˜ ë¹„êµ */
        .message-comparison {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        .comparison-item {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .comparison-item:last-child {
            margin-bottom: 0;
        }
        .comparison-label {
            width: 220px;
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        .comparison-bar-container {
            flex: 1;
            margin-right: 15px;
        }
        .comparison-bar {
            height: 30px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 5px;
            position: relative;
            transition: all 0.3s;
        }
        .comparison-bar.question-used {
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
        }
        .comparison-bar.question-not-used {
            background: linear-gradient(90deg, #fa7c91 0%, #f5576c 100%);
        }
        .comparison-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            min-width: 60px;
        }

        /* 4. ì§ˆë¬¸ì¶”ì²œ ê¸°ëŠ¥ KPI */
        .kpi-card.question { border-left-color: #43e97b; }

        .question-comparison-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .question-comparison-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-top: 4px solid #43e97b;
        }
        .question-comparison-card.not-used {
            border-top-color: #fa7c91;
        }
        .question-comparison-card h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .comparison-metric {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .comparison-metric:last-child {
            border-bottom: none;
        }
        .metric-label {
            color: #666;
            font-size: 14px;
        }
        .metric-value {
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }

        /* 5. ì½”ë“œí•´ì œ KPI */
        .kpi-card.code { border-left-color: #f093fb; }

        /* 6. ì¢…ë£Œëœ ì±„íŒ…ë°© KPI */
        .kpi-card.closed { border-left-color: #ffc107; }

        /* 7. ì§ˆë¬¸ ì½˜í…ì¸  ì¸ì‚¬ì´íŠ¸ */
        .insight-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .insight-description {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #43e97b;
        }
        .insight-description p {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.5;
        }
        .insight-description p:last-child {
            margin-bottom: 0;
        }
        .insight-description strong {
            color: #333;
        }

        /* ì§ˆë¬¸ ì½˜í…ì¸  ê·¸ë¦¬ë“œ */
        .question-content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* ì§ˆë¬¸ ì¸ê¸° í…Œì´ë¸” */
        .question-rank-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .question-rank-table h3 {
            background: #f8f9fa;
            padding: 15px;
            font-size: 16px;
            color: #333;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        .question-rank-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .question-rank-table th {
            background: #f8f9fa;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: #333;
            border-bottom: 2px solid #dee2e6;
        }
        .question-rank-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #333;
        }
        .question-rank-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        .rank-badge {
            display: inline-block;
            width: 28px;
            height: 28px;
            line-height: 28px;
            text-align: center;
            border-radius: 50%;
            font-weight: bold;
            font-size: 12px;
        }
        .rank-badge.top1 {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #333;
        }
        .rank-badge.top2 {
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
            color: #333;
        }
        .rank-badge.top3 {
            background: linear-gradient(135deg, #cd7f32 0%, #e6a055 100%);
            color: white;
        }
        .rank-badge.other {
            background: #f0f0f0;
            color: #666;
        }
        .selection-count {
            font-weight: 600;
            color: #667eea;
        }

        /* ì§ˆë¬¸ ì¹´í…Œê³ ë¦¬ ë¶„í¬ */
        .question-category-chart {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 20px;
        }
        .question-category-chart h3 {
            font-size: 16px;
            color: #333;
            font-weight: 600;
            margin-bottom: 20px;
        }

        /* 8. ë‚ ì§œë³„ í†µí•© KPI í…Œì´ë¸” */
        .kpi-table-section {
            margin-top: 40px;
        }
        .kpi-table-section h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .kpi-table-container {
            overflow-x: auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .kpi-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
        }
        .kpi-table thead {
            background: #f8f9fa;
        }
        .kpi-table th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            color: #333;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }
        .kpi-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #dee2e6;
            font-size: 13px;
            color: #333;
        }
        .kpi-table tbody tr {
            transition: all 0.2s;
            cursor: pointer;
        }
        .kpi-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        .kpi-table tbody tr.highlighted {
            background-color: #e7f3ff;
        }
        .kpi-table .date-cell {
            font-weight: 600;
            color: #667eea;
        }
        .kpi-table .positive {
            color: #28a745;
            font-weight: 600;
        }
        .kpi-table .negative {
            color: #dc3545;
            font-weight: 600;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 1200px) {
            .question-content-grid {
                grid-template-columns: 1fr;
            }
            .question-comparison-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            .main-content {
                margin-left: 0;
            }
            .date-control-form {
                flex-direction: column;
                align-items: stretch;
            }
            .kpi-summary {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<!-- ì‚¬ì´ë“œë°” -->
<div th:replace="~{fragments/sidebar :: customSidebar('kpi')}"></div>

<!-- ë©”ì¸ ì»¨í…ì¸  -->
<div class="main-content">
    <div class="container">
        <h1>ğŸ“Š KPI ëŒ€ì‹œë³´ë“œ</h1>
        <p class="page-subtitle">
            â€¢ ëª¨ë“  KPIëŠ” ë‚ ì§œë³„ ì›ë³¸ ë°ì´í„° ê¸°ì¤€<br>
            â€¢ ê¸°ê°„ ì„ íƒì€ ì¡°íšŒìš© í•„í„°<br>
            â€¢ ëª¨ë“  ì¹´ë“œÂ·ê·¸ë˜í”„Â·í…Œì´ë¸”ì€ ê¸°ê°„ í•„í„°ì™€ ì—°ë™
        </p>

        <!-- 1. ìƒë‹¨ ê¸°ê°„ ì»¨íŠ¸ë¡¤ -->
        <div class="date-control-section">
            <h2>ğŸ“Œ ê¸°ê°„ ì„ íƒ</h2>
            <div class="date-control-form">
                <div class="date-input-group">
                    <input type="date" id="startDate" value="2025-01-01">
                    <span>~</span>
                    <input type="date" id="endDate" value="2025-01-07">
                </div>
                <div class="quick-date-buttons">
                    <button class="quick-date-btn" data-days="0">ì˜¤ëŠ˜</button>
                    <button class="quick-date-btn active" data-days="7">ìµœê·¼ 7ì¼</button>
                    <button class="quick-date-btn" data-days="30">ìµœê·¼ 30ì¼</button>
                    <button class="quick-date-btn" data-days="custom">ê¸°ê°„ ì„ íƒ</button>
                </div>
                <button class="apply-btn" onclick="applyDateFilter()">
                    <i class="fa-solid fa-check"></i> ì ìš©
                </button>
            </div>
        </div>

        <!-- 2. ì‹œê·¸ë„ KPI -->
        <h2 class="section-title">2ï¸âƒ£ ì‹œê·¸ë„ KPI</h2>
        
        <div class="kpi-summary">
            <div class="kpi-card signal-sent">
                <h3>ì‹œê·¸ë„ ë³´ë‚¸ ìˆ˜</h3>
                <div class="number" id="signalSentSum">2,920</div>
                <div class="subtitle">ì„ íƒ ê¸°ê°„ í•©ê³„</div>
            </div>
            <div class="kpi-card signal-accepted">
                <h3>ì‹œê·¸ë„ ìˆ˜ë½ ìˆ˜</h3>
                <div class="number" id="signalAcceptedSum">960</div>
                <div class="subtitle">ì„ íƒ ê¸°ê°„ í•©ê³„</div>
            </div>
            <div class="kpi-card signal-rate">
                <h3>ì‹œê·¸ë„ ìˆ˜ë½ë¥ </h3>
                <div class="number" id="signalAcceptanceRate">33%</div>
                <div class="subtitle">ìˆ˜ë½ ìˆ˜ / ë³´ë‚¸ ìˆ˜</div>
            </div>
        </div>

        <div class="chart-section">
            <h2>
                <i class="fa-solid fa-paper-plane"></i>
                ì‹œê·¸ë„ ë‚ ì§œë³„ ì¶”ì´
            </h2>
            <div class="chart-container">
                <canvas id="signalChart"></canvas>
            </div>
        </div>

        <!-- 3. ì±„íŒ… KPI -->
        <h2 class="section-title">3ï¸âƒ£ â­ ì±„íŒ… KPI (í•µì‹¬)</h2>
        <p class="page-subtitle">
            <strong>ì—´ë¦° ì±„íŒ…ë°©:</strong> ì¢…ë£Œë˜ì§€ ì•Šì€ ëª¨ë“  ì±„íŒ…ë°©<br>
            <strong>í™œì„± ì±„íŒ…ë°©:</strong> ì¢…ë£Œë˜ì§€ ì•Šê³  ìµœê·¼ 7ì¼ ë‚´ ë©”ì‹œì§€ í™œë™ì´ ìˆëŠ” ì±„íŒ…ë°© (ìœ ë ¹ ì±„íŒ…ë°© ì œì™¸)
        </p>
        
        <!-- 3-1. KPI ìš”ì•½ -->
        <div class="kpi-summary">
            <div class="kpi-card chat">
                <h3>ì „ì²´ ì±„íŒ…ë°© ìˆ˜</h3>
                <div class="number" id="totalChatrooms">0</div>
                <div class="subtitle">ëª¨ë“  ì±„íŒ…ë°© (ëˆ„ì )</div>
            </div>
            <div class="kpi-card chat">
                <h3>ì—´ë¦° ì±„íŒ…ë°© ìˆ˜</h3>
                <div class="number" id="openChatrooms">0</div>
                <div class="subtitle">ì¢…ë£Œë˜ì§€ ì•Šì€ ëª¨ë“  ì±„íŒ…ë°©</div>
            </div>
            <div class="kpi-card chat">
                <h3>ê¸ˆì¼ ì—´ë¦° ì±„íŒ…ë°© ìˆ˜</h3>
                <div class="number" id="todayOpenChatrooms">0</div>
                <div class="subtitle">ì˜¤ëŠ˜ ìƒì„±ëœ ì±„íŒ…ë°©</div>
            </div>
            <div class="kpi-card chat" style="border-left-color: #43e97b;">
                <h3>í™œì„± ì±„íŒ…ë°© ìˆ˜</h3>
                <div class="number" id="activeChatrooms">0</div>
                <div class="subtitle">ìµœê·¼ 7ì¼ ë‚´ í™œë™ ìˆëŠ” ì±„íŒ…ë°©</div>
            </div>
            <div class="kpi-card chat-metric">
                <h3>FMR (ì²«ë©”ì‹œì§€ìœ¨)</h3>
                <div class="number" id="avgFMR">0%</div>
                <div class="subtitle">ì„ íƒ ê¸°ê°„ í‰ê· </div>
            </div>
            <div class="kpi-card chat-metric">
                <h3>3í„´ ì´ìƒ ëŒ€í™” ë¹„ìœ¨</h3>
                <div class="number" id="avgThreeTurn">0%</div>
                <div class="subtitle">ì„ íƒ ê¸°ê°„ í‰ê· </div>
            </div>
            <div class="kpi-card chat-metric">
                <h3>CRR (24h ì¬ë°©ë¬¸)</h3>
                <div class="number" id="avgCRR">0%</div>
                <div class="subtitle">ì„ íƒ ê¸°ê°„ í‰ê· </div>
            </div>
            <div class="kpi-card chat-metric">
                <h3>í‰ê·  ë©”ì‹œì§€ ìˆ˜</h3>
                <div class="number" id="avgMessageCount">0</div>
                <div class="subtitle">ì„ íƒ ê¸°ê°„ í‰ê· </div>
            </div>
        </div>

        <!-- 3-2. ì±„íŒ… í¼ë„ -->
        <div class="chat-funnel">
            <div class="funnel-title">ğŸ“Š ì±„íŒ… í¼ë„ (ì„ íƒ ê¸°ê°„ ìš”ì•½ Â· í™œì„± ì±„íŒ…ë°© ê¸°ì¤€)</div>
            <div class="funnel-step">
                <div class="step-name">í™œì„± ì±„íŒ…ë°©</div>
                <div class="step-value">
                    <div class="step-number" id="funnelActiveChatrooms">892</div>
                    <div class="step-percent">100%</div>
                </div>
            </div>
            <div class="funnel-arrow">â†“</div>
            <div class="funnel-step">
                <div class="step-name">ì²« ë©”ì‹œì§€ ì „ì†¡</div>
                <div class="step-value">
                    <div class="step-number" id="funnelFirstMessage">553</div>
                    <div class="step-percent" id="funnelFirstMessagePercent">62%</div>
                </div>
            </div>
            <div class="funnel-arrow">â†“</div>
            <div class="funnel-step">
                <div class="step-name">3í„´ ì´ìƒ ëŒ€í™”</div>
                <div class="step-value">
                    <div class="step-number" id="funnelThreeTurn">366</div>
                    <div class="step-percent" id="funnelThreeTurnPercent">41%</div>
                </div>
            </div>
            <div class="funnel-arrow">â†“</div>
            <div class="funnel-step">
                <div class="step-name">24ì‹œê°„ ë‚´ ì¬ë°©ë¬¸</div>
                <div class="step-value">
                    <div class="step-number" id="funnelRevisit">348</div>
                    <div class="step-percent" id="funnelRevisitPercent">39%</div>
                </div>
            </div>
        </div>

        <!-- 3-2-1. í™œì„± ì±„íŒ…ë°© ë¹„ìœ¨ í‘œì‹œ -->
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="font-size: 16px; color: #333; margin-bottom: 8px;">ğŸ’¡ ì±„íŒ…ë°© í™œì„±ë¥ </h3>
                    <p style="font-size: 13px; color: #666;">ì „ì²´ ì—´ë¦° ì±„íŒ…ë°© ì¤‘ ì‹¤ì œë¡œ í™œë™í•˜ëŠ” ë¹„ìœ¨</p>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 32px; font-weight: bold; color: #43e97b;" id="chatActivityRate">61%</div>
                    <div style="font-size: 13px; color: #999;">í™œì„± ì±„íŒ…ë°© / ì—´ë¦° ì±„íŒ…ë°©</div>
                </div>
            </div>
        </div>

        <!-- 3-3. ì±„íŒ… ì „í™˜ìœ¨ ë‚ ì§œë³„ ì¶”ì´ -->
        <div class="chart-section">
            <h2>
                <i class="fa-solid fa-chart-line"></i>
                ì—´ë¦° ì±„íŒ…ë°© vs í™œì„± ì±„íŒ…ë°© ì¶”ì´
            </h2>
            <div class="chart-container">
                <canvas id="chatroomActivityChart"></canvas>
            </div>
        </div>

        <!-- 3-4. ì±„íŒ… ì „í™˜ìœ¨ ë‚ ì§œë³„ ì¶”ì´ -->
        <div class="chart-section">
            <h2>
                <i class="fa-solid fa-comments"></i>
                ì±„íŒ… ì „í™˜ìœ¨ ë‚ ì§œë³„ ì¶”ì´
            </h2>
            <div class="chart-container">
                <canvas id="chatConversionChart"></canvas>
            </div>
        </div>

        <!-- 3-5. í‰ê·  ë©”ì‹œì§€ ìˆ˜ -->
        <div class="message-comparison">
            <h2 style="font-size: 18px; color: #333; margin-bottom: 25px;">
                <i class="fa-solid fa-chart-bar" style="color: #667eea;"></i>
                í‰ê·  ë©”ì‹œì§€ ìˆ˜
            </h2>
            <div class="comparison-item">
                <div class="comparison-label">ì „ì²´ ì±„íŒ… í‰ê· </div>
                <div class="comparison-bar-container">
                    <div class="comparison-bar" id="avgMsgBar" style="width: 42%"></div>
                </div>
                <div class="comparison-value" id="avgMsgValue">4.2</div>
            </div>
            <div class="comparison-item">
                <div class="comparison-label">ì§ˆë¬¸ì¶”ì²œ ì‚¬ìš© ì±„íŒ…</div>
                <div class="comparison-bar-container">
                    <div class="comparison-bar question-used" id="questionUsedMsgBar" style="width: 63%"></div>
                </div>
                <div class="comparison-value" id="questionUsedMsgValue">6.3</div>
            </div>
            <div class="comparison-item">
                <div class="comparison-label">ì§ˆë¬¸ì¶”ì²œ ë¯¸ì‚¬ìš© ì±„íŒ…</div>
                <div class="comparison-bar-container">
                    <div class="comparison-bar question-not-used" id="questionNotUsedMsgBar" style="width: 31%"></div>
                </div>
                <div class="comparison-value" id="questionNotUsedMsgValue">3.1</div>
            </div>
        </div>

        <!-- 4. ì§ˆë¬¸ì¶”ì²œ ê¸°ëŠ¥ KPI -->
        <h2 class="section-title">4ï¸âƒ£ ì§ˆë¬¸ì¶”ì²œ ê¸°ëŠ¥ KPI (ì±„íŒ…ë°© ë‚´ ê¸°ëŠ¥)</h2>
        <p class="page-subtitle">
            ì§ˆë¬¸ ë‚´ìš© ìì²´ëŠ” ì¸¡ì •í•˜ì§€ ì•ŠìŒ. ê¸°ëŠ¥ ì‚¬ìš© ì—¬ë¶€ì™€ íš¨ê³¼ë§Œ ì¸¡ì •
        </p>

        <!-- 4-1. KPI ìš”ì•½ -->
        <div class="kpi-summary">
            <div class="kpi-card question">
                <h3>ì§ˆë¬¸ì¶”ì²œ ë²„íŠ¼ í´ë¦­ ìˆ˜</h3>
                <div class="number" id="questionClickSum">764</div>
                <div class="subtitle">ì„ íƒ ê¸°ê°„ í•©ê³„</div>
            </div>
            <div class="kpi-card question">
                <h3>ì§ˆë¬¸ì¶”ì²œ ì‚¬ìš© ì±„íŒ…ë°© ìˆ˜</h3>
                <div class="number" id="questionUsedChatroomsSum">801</div>
                <div class="subtitle">ì„ íƒ ê¸°ê°„ í•©ê³„</div>
            </div>
        </div>

        <!-- 4-2. ë‚ ì§œë³„ ì§ˆë¬¸ì¶”ì²œ ë²„íŠ¼ í´ë¦­ ì¶”ì´ -->
        <div class="chart-section">
            <h2>
                <i class="fa-solid fa-hand-pointer"></i>
                ì§ˆë¬¸ì¶”ì²œ ë²„íŠ¼ í´ë¦­ ë‚ ì§œë³„ ì¶”ì´
            </h2>
            <div class="chart-container">
                <canvas id="questionClickChart"></canvas>
            </div>
        </div>

        <!-- 4-3. ì§ˆë¬¸ì¶”ì²œ ì‚¬ìš© ì—¬ë¶€ë³„ ëŒ€í™” ì„±ê³¼ ë¹„êµ -->
        <h3 style="font-size: 18px; color: #333; margin: 30px 0 20px 0;">
            ì§ˆë¬¸ì¶”ì²œ ì‚¬ìš© ì—¬ë¶€ë³„ ëŒ€í™” ì„±ê³¼
        </h3>
        <div class="question-comparison-grid">
            <div class="question-comparison-card">
                <h3>âœ… ì§ˆë¬¸ì¶”ì²œ ì‚¬ìš© ì±„íŒ…</h3>
                <div class="comparison-metric">
                    <div class="metric-label">í‰ê·  ë©”ì‹œì§€ ìˆ˜</div>
                    <div class="metric-value" id="questionUsedAvgMsg">6.3</div>
                </div>
                <div class="comparison-metric">
                    <div class="metric-label">3í„´ ì´ìƒ ëŒ€í™” ë¹„ìœ¨</div>
                    <div class="metric-value" id="questionUsedThreeTurn">68%</div>
                </div>
                <div class="comparison-metric">
                    <div class="metric-label">CRR (24h ì¬ë°©ë¬¸ë¥ )</div>
                    <div class="metric-value" id="questionUsedCRR">46%</div>
                </div>
            </div>
            <div class="question-comparison-card not-used">
                <h3>âŒ ì§ˆë¬¸ì¶”ì²œ ë¯¸ì‚¬ìš© ì±„íŒ…</h3>
                <div class="comparison-metric">
                    <div class="metric-label">í‰ê·  ë©”ì‹œì§€ ìˆ˜</div>
                    <div class="metric-value" id="questionNotUsedAvgMsg">3.1</div>
                </div>
                <div class="comparison-metric">
                    <div class="metric-label">3í„´ ì´ìƒ ëŒ€í™” ë¹„ìœ¨</div>
                    <div class="metric-value" id="questionNotUsedThreeTurn">29%</div>
                </div>
                <div class="comparison-metric">
                    <div class="metric-label">CRR (24h ì¬ë°©ë¬¸ë¥ )</div>
                    <div class="metric-value" id="questionNotUsedCRR">28%</div>
                </div>
            </div>
        </div>

        <!-- 5. ì½”ë“œí•´ì œ KPI -->
        <h2 class="section-title">5ï¸âƒ£ ì½”ë“œí•´ì œ KPI</h2>

        <div class="kpi-summary">
            <div class="kpi-card code">
                <h3>ì½”ë“œí•´ì œ ìš”ì²­ ìˆ˜</h3>
                <div class="number" id="codeUnlockRequestSum">123</div>
                <div class="subtitle">ì„ íƒ ê¸°ê°„ í•©ê³„</div>
            </div>
            <div class="kpi-card code">
                <h3>ì½”ë“œí•´ì œ ìŠ¹ì¸ ìˆ˜</h3>
                <div class="number" id="codeUnlockApprovedSum">27</div>
                <div class="subtitle">ì„ íƒ ê¸°ê°„ í•©ê³„</div>
            </div>
            <div class="kpi-card code">
                <h3>ì½”ë“œí•´ì œ ìŠ¹ì¸ë¥ </h3>
                <div class="number" id="codeUnlockApprovalRate">22%</div>
                <div class="subtitle">ìŠ¹ì¸ ìˆ˜ / ìš”ì²­ ìˆ˜</div>
            </div>
        </div>

        <div class="chart-section">
            <h2>
                <i class="fa-solid fa-key"></i>
                ì½”ë“œí•´ì œ ë‚ ì§œë³„ ì¶”ì´
            </h2>
            <div class="chart-container">
                <canvas id="codeReleaseChart"></canvas>
            </div>
        </div>

        <!-- 6. ì¢…ë£Œëœ ì±„íŒ…ë°© KPI -->
        <h2 class="section-title">6ï¸âƒ£ ì¢…ë£Œëœ ì±„íŒ…ë°© KPI (ë³´ì¡°)</h2>

        <div class="kpi-summary">
            <div class="kpi-card closed">
                <h3>ì¢…ë£Œëœ ì±„íŒ…ë°© ìˆ˜</h3>
                <div class="number" id="closedChatroomsSum">84</div>
                <div class="subtitle">ì„ íƒ ê¸°ê°„ í•©ê³„</div>
            </div>
            <div class="kpi-card closed">
                <h3>í‰ê·  ì±„íŒ… ìœ ì§€ ê¸°ê°„</h3>
                <div class="number" id="avgChatDurationDays">12.4ì¼</div>
                <div class="subtitle">ì„ íƒ ê¸°ê°„ í‰ê· </div>
            </div>
        </div>

        <!-- 7. ì§ˆë¬¸ ì½˜í…ì¸  ì¸ì‚¬ì´íŠ¸ -->
        <h2 class="section-title">7ï¸âƒ£ â­ ì§ˆë¬¸ ì½˜í…ì¸  ì¸ì‚¬ì´íŠ¸ (í”„ë¡œí•„ ì½”ë“œ ì§ˆë¬¸)</h2>
        
        <div class="insight-section">
            <div class="insight-description">
                <p><strong>â€» ì§ˆë¬¸ì¶”ì²œ ê¸°ëŠ¥ê³¼ ë¬´ê´€</strong></p>
                <p>â€¢ í”„ë¡œí•„ ì½”ë“œ ì§ˆë¬¸ ì„ íƒ íšŸìˆ˜ ê¸°ì¤€</p>
                <p>â€¢ ì§ˆë¬¸ë³„ ì„ íƒ ìˆœìœ„ ë° ì¹´í…Œê³ ë¦¬ë³„ ì„ íƒ ë¹„ì¤‘</p>
                <p>â€¢ íšŒì›ê°€ì… ì‹œ / í”„ë¡œí•„ ìˆ˜ì • ì‹œ ìœ ì €ê°€ ì§ì ‘ ì„ íƒí•œ ì§ˆë¬¸ ë°ì´í„°</p>
            </div>

            <div class="question-content-grid">
                <!-- ì§ˆë¬¸ ì¸ê¸° TOP ë¦¬ìŠ¤íŠ¸ -->
                <div class="question-rank-table">
                    <h3>
                        <i class="fa-solid fa-trophy"></i>
                        ì¸ê¸° ì§ˆë¬¸ TOP 10
                    </h3>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 70px;">ìˆœìœ„</th>
                                <th>ì§ˆë¬¸ ë‚´ìš©</th>
                                <th style="width: 100px; text-align: right;">ì„ íƒ íšŸìˆ˜</th>
                            </tr>
                        </thead>
                        <tbody id="questionRankTableBody">
                            <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                        </tbody>
                    </table>
                </div>

                <!-- ì§ˆë¬¸ ì¹´í…Œê³ ë¦¬ ë¶„í¬ -->
                <div class="question-category-chart">
                    <h3>
                        <i class="fa-solid fa-chart-pie"></i>
                        ì§ˆë¬¸ ì¹´í…Œê³ ë¦¬ ë¶„í¬
                    </h3>
                    <div class="chart-container small">
                        <canvas id="questionCategoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 8. ë‚ ì§œë³„ í†µí•© KPI í…Œì´ë¸” -->
        <div class="kpi-table-section">
            <h2>
                <i class="fa-solid fa-table"></i>
                ë‚ ì§œë³„ í†µí•© KPI ë¡œê·¸ (ì›ë³¸ ë°ì´í„°)
            </h2>
            <div class="kpi-table-container">
                <table class="kpi-table">
                    <thead>
                        <tr>
                            <th rowspan="2">ë‚ ì§œ</th>
                            <th colspan="2">ì‹œê·¸ë„</th>
                            <th colspan="5">ì±„íŒ…</th>
                            <th rowspan="2">í‰ê· <br>ë©”ì‹œì§€</th>
                            <th rowspan="2">ì§ˆë¬¸<br>í´ë¦­</th>
                            <th colspan="2">ì½”ë“œí•´ì œ</th>
                            <th rowspan="2">ì¢…ë£Œ<br>ì±„íŒ…</th>
                        </tr>
                        <tr>
                            <th>ë³´ëƒ„</th>
                            <th>ìˆ˜ë½</th>
                            <th>ì—´ë¦°<br>ì±„íŒ…</th>
                            <th>í™œì„±<br>ì±„íŒ…</th>
                            <th>FMR</th>
                            <th>3í„´<br>ì´ìƒ</th>
                            <th>CRR</th>
                            <th>ìš”ì²­</th>
                            <th>ìŠ¹ì¸</th>
                        </tr>
                    </thead>
                    <tbody id="kpiTableBody">
                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
    let charts = {};
    let kpiData = null;

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return (date.getMonth() + 1) + '/' + date.getDate();
    }

    function getDateRange(start, end) {
        const dates = [];
        const current = new Date(start);
        const endDate = new Date(end);
        
        while (current <= endDate) {
            dates.push(current.toISOString().split('T')[0]);
            current.setDate(current.getDate() + 1);
        }
        return dates;
    }

    // ë¹ ë¥¸ ë‚ ì§œ ë²„íŠ¼
    document.querySelectorAll('.quick-date-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.quick-date-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const days = this.getAttribute('data-days');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let startDate = new Date(today);
            
            if (days === 'custom') {
                return;
            } else if (days === '0') {
                startDate = today;
            } else {
                startDate.setDate(today.getDate() - parseInt(days) + 1);
            }
            
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        });
    });

    async function fetchKpiData(startDate, endDate) {
        try {
            const response = await fetch('/v1/admin/kpi/summary?startDate=' + startDate + '&endDate=' + endDate);
            if (!response.ok) {
                throw new Error('KPI ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨');
            }
            return await response.json();
        } catch (error) {
            console.error('Error fetching KPI data:', error);
            alert('KPI ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            return null;
        }
    }

    async function fetchChatroomStatistics() {
        try {
            const response = await fetch('/v1/admin/kpi/chatroom-statistics');
            if (!response.ok) {
                throw new Error('ì±„íŒ…ë°© í†µê³„ ì¡°íšŒ ì‹¤íŒ¨');
            }
            return await response.json();
        } catch (error) {
            console.error('Error fetching chatroom statistics:', error);
            return null;
        }
    }

    function applyDateFilter() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        updateDashboard(startDate, endDate);
    }

    async function updateDashboard(startDate, endDate) {
        kpiData = await fetchKpiData(startDate, endDate);
        if (!kpiData) return;

        // ì‹¤ì‹œê°„ ì±„íŒ…ë°© í†µê³„ ì¡°íšŒ
        const chatroomStats = await fetchChatroomStatistics();

        // 2. ì‹œê·¸ë„ KPI
        document.getElementById('signalSentSum').textContent = kpiData.signalSentSum.toLocaleString();
        document.getElementById('signalAcceptedSum').textContent = kpiData.signalAcceptedSum.toLocaleString();
        document.getElementById('signalAcceptanceRate').textContent = kpiData.signalAcceptanceRateAvg.toFixed(1) + '%';

        // 3. ì±„íŒ… KPI - ì‹¤ì‹œê°„ í†µê³„
        if (chatroomStats) {
            document.getElementById('totalChatrooms').textContent = chatroomStats.totalChatrooms.toLocaleString();
            document.getElementById('openChatrooms').textContent = chatroomStats.openChatrooms.toLocaleString();
            document.getElementById('activeChatrooms').textContent = chatroomStats.activeChatrooms.toLocaleString();
            document.getElementById('chatActivityRate').textContent = chatroomStats.activeChatroomRate.toFixed(1) + '%';
        }

        // 3. ì±„íŒ… KPI - ê¸ˆì¼ ì—´ë¦° ì±„íŒ…ë°© ìˆ˜ (ì˜¤ëŠ˜ ë‚ ì§œì˜ DailyKpiì—ì„œ ì¡°íšŒ)
        const today = new Date().toISOString().split('T')[0];
        const todayKpi = kpiData.dailyKpis.find(d => d.targetDate === today);
        if (todayKpi) {
            document.getElementById('todayOpenChatrooms').textContent = todayKpi.openChatroomsCount.toLocaleString();
        } else {
            document.getElementById('todayOpenChatrooms').textContent = '0';
        }

        // 3. ì±„íŒ… KPI - í‰ê·  ì§€í‘œ
        document.getElementById('avgFMR').textContent = kpiData.firstMessageRateAvg.toFixed(1) + '%';
        document.getElementById('avgThreeTurn').textContent = kpiData.threeTurnRateAvg.toFixed(1) + '%';
        document.getElementById('avgCRR').textContent = kpiData.chatReturnRateAvg.toFixed(1) + '%';
        document.getElementById('avgMessageCount').textContent = kpiData.avgMessageCountAvg.toFixed(1);

        // 3-2. ì±„íŒ… í¼ë„ ë°ì´í„°
        const activeChatrooms = kpiData.activeChatroomsSum;
        const firstMessageCount = Math.round(activeChatrooms * kpiData.firstMessageRateAvg / 100);
        const threeTurnCount = Math.round(activeChatrooms * kpiData.threeTurnRateAvg / 100);
        const revisitCount = Math.round(activeChatrooms * kpiData.chatReturnRateAvg / 100);

        document.getElementById('funnelActiveChatrooms').textContent = activeChatrooms.toLocaleString();
        document.getElementById('funnelFirstMessage').textContent = firstMessageCount.toLocaleString();
        document.getElementById('funnelFirstMessagePercent').textContent = kpiData.firstMessageRateAvg.toFixed(0) + '%';
        document.getElementById('funnelThreeTurn').textContent = threeTurnCount.toLocaleString();
        document.getElementById('funnelThreeTurnPercent').textContent = kpiData.threeTurnRateAvg.toFixed(0) + '%';
        document.getElementById('funnelRevisit').textContent = revisitCount.toLocaleString();
        document.getElementById('funnelRevisitPercent').textContent = kpiData.chatReturnRateAvg.toFixed(0) + '%';

        // 3-5. í‰ê·  ë©”ì‹œì§€ ìˆ˜ ë°” ì—…ë°ì´íŠ¸
        const avgMsg = kpiData.avgMessageCountAvg;
        const questionUsedMsg = kpiData.questionUsedAvgMessageCountAvg;
        const questionNotUsedMsg = kpiData.questionNotUsedAvgMessageCountAvg;
        const maxMsg = Math.max(avgMsg, questionUsedMsg, questionNotUsedMsg, 1);

        document.getElementById('avgMsgValue').textContent = avgMsg.toFixed(1);
        document.getElementById('avgMsgBar').style.width = ((avgMsg / maxMsg) * 100) + '%';

        document.getElementById('questionUsedMsgValue').textContent = questionUsedMsg.toFixed(1);
        document.getElementById('questionUsedMsgBar').style.width = ((questionUsedMsg / maxMsg) * 100) + '%';

        document.getElementById('questionNotUsedMsgValue').textContent = questionNotUsedMsg.toFixed(1);
        document.getElementById('questionNotUsedMsgBar').style.width = ((questionNotUsedMsg / maxMsg) * 100) + '%';

        // 4. ì§ˆë¬¸ KPI
        document.getElementById('questionClickSum').textContent = kpiData.questionClickSum.toLocaleString();
        document.getElementById('questionUsedChatroomsSum').textContent = kpiData.questionUsedChatroomsSum.toLocaleString();

        // 4-3. ì§ˆë¬¸ ì‚¬ìš© ì—¬ë¶€ë³„ ëŒ€í™” ì„±ê³¼ ë¹„êµ
        document.getElementById('questionUsedAvgMsg').textContent = kpiData.questionUsedAvgMessageCountAvg.toFixed(1);
        document.getElementById('questionUsedThreeTurn').textContent = kpiData.questionUsedThreeTurnRateAvg.toFixed(0) + '%';
        document.getElementById('questionUsedCRR').textContent = kpiData.questionUsedChatReturnRateAvg.toFixed(0) + '%';

        document.getElementById('questionNotUsedAvgMsg').textContent = kpiData.questionNotUsedAvgMessageCountAvg.toFixed(1);
        document.getElementById('questionNotUsedThreeTurn').textContent = kpiData.questionNotUsedThreeTurnRateAvg.toFixed(0) + '%';
        document.getElementById('questionNotUsedCRR').textContent = kpiData.questionNotUsedChatReturnRateAvg.toFixed(0) + '%';

        // 5. ì½”ë“œí•´ì œ KPI
        document.getElementById('codeUnlockRequestSum').textContent = kpiData.codeUnlockRequestSum.toLocaleString();
        document.getElementById('codeUnlockApprovedSum').textContent = kpiData.codeUnlockApprovedSum.toLocaleString();
        document.getElementById('codeUnlockApprovalRate').textContent = kpiData.codeUnlockApprovalRateAvg.toFixed(1) + '%';

        // 6. ì¢…ë£Œëœ ì±„íŒ… KPI
        document.getElementById('closedChatroomsSum').textContent = kpiData.closedChatroomsSum.toLocaleString();
        document.getElementById('avgChatDurationDays').textContent = kpiData.avgChatDurationDaysAvg.toFixed(1) + 'ì¼';

        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        updateCharts();

        // KPI í…Œì´ë¸” ì—…ë°ì´íŠ¸
        updateKpiTable();
    }

    function updateCharts() {
        if (!kpiData || !kpiData.dailyKpis) return;

        const dailyKpis = kpiData.dailyKpis;
        const labels = dailyKpis.map(d => formatDate(d.targetDate));

        // ì‹œê·¸ë„ ì°¨íŠ¸
        updateOrCreateChart('signalChart', {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'ì‹œê·¸ë„ ë³´ëƒ„',
                        data: dailyKpis.map(d => d.signalSentCount),
                        borderColor: '#6c63ff',
                        backgroundColor: 'rgba(108, 99, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'ì‹œê·¸ë„ ìˆ˜ë½',
                        data: dailyKpis.map(d => d.signalAcceptedCount),
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                scales: { y: { beginAtZero: true } }
            }
        });

        // ì±„íŒ…ë°© í™œë™ ì°¨íŠ¸
        updateOrCreateChart('chatroomActivityChart', {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'ì—´ë¦° ì±„íŒ…ë°©',
                        data: dailyKpis.map(d => d.openChatroomsCount),
                        backgroundColor: '#667eea',
                        borderRadius: 8
                    },
                    {
                        label: 'í™œì„± ì±„íŒ…ë°©',
                        data: dailyKpis.map(d => d.activeChatroomsCount),
                        backgroundColor: '#764ba2',
                        borderRadius: 8
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                scales: { y: { beginAtZero: true } }
            }
        });

        // ì±„íŒ… ì „í™˜ìœ¨ ì°¨íŠ¸
        updateOrCreateChart('chatConversionChart', {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'FMR (%)',
                        data: dailyKpis.map(d => d.firstMessageRate),
                        borderColor: '#f093fb',
                        tension: 0.4
                    },
                    {
                        label: '3í„´ ë¹„ìœ¨ (%)',
                        data: dailyKpis.map(d => d.threeTurnRate),
                        borderColor: '#4facfe',
                        tension: 0.4
                    },
                    {
                        label: 'CRR (%)',
                        data: dailyKpis.map(d => d.chatReturnRate),
                        borderColor: '#43e97b',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                scales: { y: { beginAtZero: true, max: 100 } }
            }
        });

        // ì§ˆë¬¸ í´ë¦­ ì°¨íŠ¸
        updateOrCreateChart('questionClickChart', {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ì§ˆë¬¸ í´ë¦­ ìˆ˜',
                    data: dailyKpis.map(d => d.questionClickCount),
                    backgroundColor: '#f5576c',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });

        // ì½”ë“œí•´ì œ ì°¨íŠ¸
        updateOrCreateChart('codeReleaseChart', {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'ìš”ì²­',
                        data: dailyKpis.map(d => d.codeUnlockRequestCount),
                        borderColor: '#ffc107',
                        tension: 0.4
                    },
                    {
                        label: 'ìŠ¹ì¸',
                        data: dailyKpis.map(d => d.codeUnlockApprovedCount),
                        borderColor: '#28a745',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    function updateOrCreateChart(canvasId, config) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;

        if (charts[canvasId]) {
            charts[canvasId].destroy();
        }
        charts[canvasId] = new Chart(ctx, config);
    }

    // KPI í…Œì´ë¸” ì—…ë°ì´íŠ¸
    function updateKpiTable() {
        if (!kpiData || !kpiData.dailyKpis) return;

        const tbody = document.getElementById('kpiTableBody');
        if (!tbody) return;

        tbody.innerHTML = '';

        kpiData.dailyKpis.forEach(daily => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="date-cell">${formatDate(daily.targetDate)}</td>
                <td>${daily.signalSentCount}</td>
                <td>${daily.signalAcceptedCount}</td>
                <td>${daily.openChatroomsCount}</td>
                <td>${daily.activeChatroomsCount}</td>
                <td>${daily.firstMessageRate.toFixed(1)}%</td>
                <td>${daily.threeTurnRate.toFixed(1)}%</td>
                <td>${daily.chatReturnRate.toFixed(1)}%</td>
                <td>${daily.avgMessageCount.toFixed(1)}</td>
                <td>${daily.questionClickCount}</td>
                <td>${daily.codeUnlockRequestCount}</td>
                <td>${daily.codeUnlockApprovedCount}</td>
                <td>${daily.closedChatroomsCount}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // ì§ˆë¬¸ ì½˜í…ì¸  ì¸ì‚¬ì´íŠ¸ ë¡œë“œ
    async function loadQuestionInsights() {
        try {
            const response = await fetch('/v1/admin/kpi/question-insights');
            if (!response.ok) {
                throw new Error('ì§ˆë¬¸ ì¸ì‚¬ì´íŠ¸ ì¡°íšŒ ì‹¤íŒ¨');
            }
            const data = await response.json();

            // TOP 10 ì§ˆë¬¸ í…Œì´ë¸” ë Œë”ë§
            const tbody = document.getElementById('questionRankTableBody');
            if (tbody && data.topQuestions) {
                tbody.innerHTML = '';
                data.topQuestions.forEach((q, index) => {
                    const rank = index + 1;
                    const badgeClass = rank === 1 ? 'top1' : rank === 2 ? 'top2' : rank === 3 ? 'top3' : 'other';
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="rank-badge ${badgeClass}">${rank}</span></td>
                        <td>${q.content}</td>
                        <td class="selection-count" style="text-align: right;">${q.selectionCount}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // ì¹´í…Œê³ ë¦¬ ë¶„í¬ ì°¨íŠ¸ ë Œë”ë§
            if (data.categoryStats && data.categoryStats.length > 0) {
                const labels = data.categoryStats.map(c => c.category);
                const counts = data.categoryStats.map(c => c.count);

                updateOrCreateChart('questionCategoryChart', {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: counts,
                            backgroundColor: [
                                '#667eea', '#764ba2', '#f093fb', '#4facfe',
                                '#43e97b', '#fa7c91', '#ffc107', '#28a745'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('ì§ˆë¬¸ ì¸ì‚¬ì´íŠ¸ ë¡œë”© ì‹¤íŒ¨:', error);
        }
    }

    // ì´ˆê¸° ë¡œë“œ
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const sevenDaysAgo = new Date(today);
        sevenDaysAgo.setDate(today.getDate() - 6);
        
        document.getElementById('startDate').value = sevenDaysAgo.toISOString().split('T')[0];
        document.getElementById('endDate').value = today.toISOString().split('T')[0];

        // 7ì¼ ë²„íŠ¼ í™œì„±í™”
        const sevenDayBtn = document.querySelector('[data-days="7"]');
        if (sevenDayBtn) sevenDayBtn.classList.add('active');

        updateDashboard(sevenDaysAgo.toISOString().split('T')[0], today.toISOString().split('T')[0]);

        // ì§ˆë¬¸ ì¸ì‚¬ì´íŠ¸ ë¡œë“œ
        loadQuestionInsights();
    });
</script>
</body>
</html>
