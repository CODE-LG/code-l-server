<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì§ˆë¬¸ ìˆ˜ì •</title>
    <link rel="icon" th:href="@{/image/favicon.png}" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #f4f6f9;
        }

        .sidebar {
            min-height: 100vh;
            background: #343a40;
        }

        .sidebar .nav-link {
            color: #fff;
        }

        .sidebar .nav-link.active, .sidebar .nav-link:hover {
            background: #495057;
        }

        .form-card {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
        }

        .info-box {
            background: #E3F2FD;
            border-left: 3px solid #4A90E2;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
        }

        .info-box-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #4A90E2;
        }

        .info-box ul {
            margin-left: 1.5rem;
            font-size: 0.85rem;
            color: #7F8C8D;
            margin-bottom: 0;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div th:replace="~{fragments/sidebar :: sidebar('questions')}"></div>

        <!-- Main -->
        <main class="col-md-10 ms-sm-auto px-md-5 py-5">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="fw-bold">ì§ˆë¬¸ ìˆ˜ì •</h1>
                <a th:href="@{/v1/admin/questions(keyword=${filterKeyword}, category=${filterCategory}, isActive=${filterIsActive}, page=${filterPage}, size=${filterSize})}"
                   class="btn btn-outline-secondary">
                    <i class="fa-solid fa-arrow-left"></i> ëª©ë¡ìœ¼ë¡œ
                </a>
            </div>

            <div class="card form-card">
                <div class="card-body">
                    <div class="info-box">
                        <div class="info-box-title">ğŸ“Œ ê·¸ë£¹ ì„¤ì • ê°€ì´ë“œ</div>
                        <ul>
                            <li><strong>Aê·¸ë£¹:</strong> ê°€ë²¼ìš´/ì§„ì…ìš© ì§ˆë¬¸ (ë¨¼ì € ë…¸ì¶œ, ëŒ€í™” ì‹œì‘ì— ì í•©)</li>
                            <li><strong>Bê·¸ë£¹:</strong> ê¹Šì´ìˆëŠ”/ë¬´ê²Œê° ì§ˆë¬¸ (Aê·¸ë£¹ ì†Œì§„ í›„ ë…¸ì¶œ)</li>
                            <li><strong>ëœë¤:</strong> í…ì…˜ì—… ì½”ë“œ ë“± ê·¸ë£¹ êµ¬ë¶„ ì—†ëŠ” ì§ˆë¬¸</li>
                        </ul>
                    </div>

                    <form th:action="@{/v1/admin/questions/{id}(id=${question.id})}" method="post">
                        <!-- í•„í„° íŒŒë¼ë¯¸í„° ìœ ì§€ -->
                        <input type="hidden" name="keyword" th:value="${filterKeyword}">
                        <input type="hidden" name="filterCategory" th:value="${filterCategory}">
                        <input type="hidden" name="filterIsActive" th:value="${filterIsActive}">
                        <input type="hidden" name="page" th:value="${filterPage}">
                        <input type="hidden" name="size" th:value="${filterSize}">

                        <!-- ê¸°ì¡´ ì¹´í…Œê³ ë¦¬ ê°’ ì €ì¥ (JavaScriptì—ì„œ ì‚¬ìš©) -->
                        <input type="hidden" id="currentCategory" th:value="${question.category.name}">
                        <input type="hidden" id="currentGroup" th:value="${question.questionGroup.name}">

                        <div class="mb-4">
                            <label for="content" class="form-label fw-bold">ì§ˆë¬¸ ë‚´ìš© <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="content" name="content" rows="3"
                                      placeholder="ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" required maxlength="500"
                                      th:text="${question.content}"></textarea>
                            <div class="form-text">ìµœëŒ€ 500ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
                        </div>

                        <div class="mb-4">
                            <label for="purpose" class="form-label fw-bold">ìš©ë„ <span class="text-danger">*</span></label>
                            <select class="form-select" id="purpose" required>
                                <option value="">ìš©ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="chatroom">ì±„íŒ…ë°© ì§ˆë¬¸ ì¶”ì²œ</option>
                                <option value="profile">íšŒì›ê°€ì…Â·í”„ë¡œí•„ ìˆ˜ì •</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="category" class="form-label fw-bold">ì¹´í…Œê³ ë¦¬ <span class="text-danger">*</span></label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="">ë¨¼ì € ìš©ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                        </div>

                        <div class="mb-4" id="groupContainer">
                            <label for="questionGroup" class="form-label fw-bold">ì§ˆë¬¸ ê·¸ë£¹ <span class="text-danger">*</span></label>
                            <select class="form-select" id="questionGroup" name="questionGroup" required>
                                <option value="">ê·¸ë£¹ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                <option th:each="group : ${questionGroups}"
                                        th:value="${group.name}"
                                        th:text="${group.displayName}"></option>
                            </select>
                            <div class="form-text">Aê·¸ë£¹ì€ ìš°ì„  ì¶”ì²œ, Bê·¸ë£¹ì€ Aê·¸ë£¹ ì†Œì§„ í›„ ì¶”ì²œë©ë‹ˆë‹¤. í…ì…˜ì—… ì¹´í…Œê³ ë¦¬ëŠ” ëœë¤ì„ ì„ íƒí•˜ì„¸ìš”.</div>
                        </div>

                        <div class="mb-4">
                            <label for="description" class="form-label fw-bold">ì§ˆë¬¸ ì„¤ëª…</label>
                            <textarea class="form-control" id="description" name="description" rows="2"
                                      placeholder="ì§ˆë¬¸ì— ëŒ€í•œ ë¶€ê°€ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)" maxlength="1000"
                                      th:text="${question.description}"></textarea>
                            <div class="form-text">ìµœëŒ€ 1000ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
                        </div>

                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isActive" name="isActive" value="true"
                                       th:checked="${question.isActive}">
                                <label class="form-check-label fw-bold" for="isActive">
                                    í™œì„± ìƒíƒœ
                                </label>
                                <div class="form-text">ì²´í¬ í•´ì œ ì‹œ ë¹„í™œì„± ìƒíƒœë¡œ ë“±ë¡ë©ë‹ˆë‹¤.</div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fa-solid fa-save"></i> ìˆ˜ì •
                            </button>
                            <a th:href="@{/v1/admin/questions(keyword=${filterKeyword}, category=${filterCategory}, isActive=${filterIsActive}, page=${filterPage}, size=${filterSize})}"
                               class="btn btn-outline-secondary">
                                <i class="fa-solid fa-times"></i> ì·¨ì†Œ
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ìš©ë„ë³„ ì¹´í…Œê³ ë¦¬ ì˜µì…˜
    const categoryOptions = {
        chatroom: [
            { value: 'VALUES', label: 'ê°€ì¹˜ê´€ ì½”ë“œ' },
            { value: 'TENSION_UP', label: 'í…ì…˜ì—… ì½”ë“œ' },
            { value: 'IF', label: 'ë§Œì•½ì— ì½”ë“œ' },
            { value: 'SECRET', label: 'ë¹„ë°€ ì½”ë“œ (19+)' }
        ],
        profile: [
            { value: 'VALUES', label: 'ê°€ì¹˜ê´€' },
            { value: 'FAVORITE', label: 'favorite' },
            { value: 'DATE', label: 'ë°ì´íŠ¸' },
            { value: 'MEMORY', label: 'ì¶”ì–µ' },
            { value: 'WANT_TALK', label: 'ì´ëŸ°ëŒ€í™”í•´ë³´ê³ ì‹¶ì–´' }
        ]
    };

    // ì¹´í…Œê³ ë¦¬ë³„ ìš©ë„ ë§¤í•‘
    const categoryToPurpose = {
        'VALUES': 'both', // ì–‘ìª½ ëª¨ë‘ ê°€ëŠ¥
        'TENSION_UP': 'chatroom',
        'IF': 'chatroom',
        'SECRET': 'chatroom',
        'FAVORITE': 'profile',
        'DATE': 'profile',
        'MEMORY': 'profile',
        'WANT_TALK': 'profile'
    };

    // íšŒì›ê°€ì… ì „ìš© ì¹´í…Œê³ ë¦¬ (ê·¸ë£¹ ìë™ RANDOM)
    const signupOnlyCategories = ['FAVORITE', 'DATE', 'MEMORY', 'WANT_TALK'];

    const purposeSelect = document.getElementById('purpose');
    const categorySelect = document.getElementById('category');
    const groupSelect = document.getElementById('questionGroup');
    const groupContainer = document.getElementById('groupContainer');

    // ê¸°ì¡´ ê°’
    const currentCategory = document.getElementById('currentCategory').value;
    const currentGroup = document.getElementById('currentGroup').value;

    // ìš©ë„ ë³€ê²½ ì‹œ ì¹´í…Œê³ ë¦¬ ì˜µì…˜ ì—…ë°ì´íŠ¸
    function updateCategoryOptions(selectedCategory = null) {
        const purpose = purposeSelect.value;

        if (!purpose) {
            categorySelect.innerHTML = '<option value="">ë¨¼ì € ìš©ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            return;
        }

        const options = categoryOptions[purpose];
        let html = '<option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
        options.forEach(opt => {
            const selected = selectedCategory === opt.value ? ' selected' : '';
            html += `<option value="${opt.value}"${selected}>${opt.label}</option>`;
        });
        categorySelect.innerHTML = html;

        updateGroupSelector();
    }

    // ê·¸ë£¹ ì„ íƒê¸° ì—…ë°ì´íŠ¸
    function updateGroupSelector() {
        const purpose = purposeSelect.value;
        const selectedCategory = categorySelect.value;

        if (purpose === 'profile' || signupOnlyCategories.includes(selectedCategory)) {
            // íšŒì›ê°€ì…Â·í”„ë¡œí•„ ìˆ˜ì • ìš©ë„: ê·¸ë£¹ì„ RANDOMìœ¼ë¡œ ê³ ì •
            groupSelect.value = 'RANDOM';
            groupSelect.disabled = true;
            groupSelect.removeAttribute('required');
            groupContainer.querySelector('.form-text').textContent =
                'íšŒì›ê°€ì…Â·í”„ë¡œí•„ ìˆ˜ì • ìš©ë„ì˜ ì§ˆë¬¸ì€ ê·¸ë£¹ì´ ìë™ìœ¼ë¡œ \'ëœë¤\'ìœ¼ë¡œ ì§€ì •ë©ë‹ˆë‹¤.';
        } else {
            // ì±„íŒ…ë°© ìš©ë„: ê·¸ë£¹ ì„ íƒ ê°€ëŠ¥
            groupSelect.disabled = false;
            groupSelect.setAttribute('required', 'required');
            groupContainer.querySelector('.form-text').textContent =
                'Aê·¸ë£¹ì€ ìš°ì„  ì¶”ì²œ, Bê·¸ë£¹ì€ Aê·¸ë£¹ ì†Œì§„ í›„ ì¶”ì²œë©ë‹ˆë‹¤. í…ì…˜ì—… ì¹´í…Œê³ ë¦¬ëŠ” ëœë¤ì„ ì„ íƒí•˜ì„¸ìš”.';
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        // ê¸°ì¡´ ì¹´í…Œê³ ë¦¬ë¡œ ìš©ë„ ê²°ì •
        const purpose = categoryToPurpose[currentCategory];

        if (purpose === 'both') {
            // VALUESëŠ” ì±„íŒ…ë°© ìš©ë„ë¡œ ê¸°ë³¸ ì„¤ì • (ì±„íŒ…ë°©ì—ì„œ ì‚¬ìš©ë˜ëŠ” ê²½ìš°ê°€ ë” í”í•¨)
            // ê·¸ë£¹ì´ RANDOMì´ë©´ profile, ì•„ë‹ˆë©´ chatroomìœ¼ë¡œ ì¶”ì •
            if (currentGroup === 'RANDOM') {
                purposeSelect.value = 'profile';
            } else {
                purposeSelect.value = 'chatroom';
            }
        } else if (purpose === 'chatroom') {
            purposeSelect.value = 'chatroom';
        } else {
            purposeSelect.value = 'profile';
        }

        // ì¹´í…Œê³ ë¦¬ ì˜µì…˜ ì—…ë°ì´íŠ¸ ë° ê¸°ì¡´ ê°’ ì„ íƒ
        updateCategoryOptions(currentCategory);

        // ê¸°ì¡´ ê·¸ë£¹ ê°’ ì„¤ì •
        if (!groupSelect.disabled) {
            groupSelect.value = currentGroup;
        }
    });

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    purposeSelect.addEventListener('change', function() {
        updateCategoryOptions();
    });
    categorySelect.addEventListener('change', updateGroupSelector);

    // í¼ ì œì¶œ ì‹œ disabled í•„ë“œë„ ì „ì†¡ë˜ë„ë¡ ì²˜ë¦¬
    document.querySelector('form').addEventListener('submit', function() {
        if (groupSelect.disabled) {
            groupSelect.disabled = false;
        }
    });
</script>
</body>
</html>
