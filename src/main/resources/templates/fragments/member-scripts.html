<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<body>

<script th:fragment="member-detail-scripts" th:inline="javascript">
    const memberId = /*[[${member.id}]]*/ 0;
    let currentImageSrc = '';

    // 이미지 모달 표시
    function showImageModal(src, title) {
        currentImageSrc = src;
        document.getElementById('modalImage').src = src;
        document.getElementById('imageModalTitle').textContent = title;
        new bootstrap.Modal(document.getElementById('imageModal')).show();
    }

    // 이미지 다운로드
    function downloadImage() {
        const link = document.createElement('a');
        link.href = currentImageSrc;
        link.download = 'member_image_' + memberId + '_' + Date.now() + '.jpg';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // 승인 처리
    function approveMember() {
        new bootstrap.Modal(document.getElementById('approveModal')).show();
    }

    function confirmApprove() {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/v1/admin/approval/${memberId}`;
        document.body.appendChild(form);
        form.submit();
    }

    // 거절 처리
    function rejectMember() {
        new bootstrap.Modal(document.getElementById('rejectModal')).show();
    }

    function confirmReject() {
        const reason = document.getElementById('rejectReason').value.trim();
        if (!reason) {
            alert('거절 사유를 입력해주세요.');
            return;
        }

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/v1/admin/reject/${memberId}`;

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'rejectReason';
        input.value = reason;
        form.appendChild(input);

        document.body.appendChild(form);
        form.submit();
    }

    // 기타 기능들
    function banMember() {
        alert('정지 기능은 추후 구현 예정입니다.');
    }

    function unbanMember() {
        alert('정지 해제 기능은 추후 구현 예정입니다.');
    }

    function sendMessage() {
        alert('메시지 발송 기능은 추후 구현 예정입니다.');
    }

    function exportMemberData() {
        alert('데이터 내보내기 기능은 추후 구현 예정입니다.');
    }

    function deleteMember() {
        if (confirm('정말로 이 회원을 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.')) {
            alert('회원 삭제 기능은 추후 구현 예정입니다.');
        }
    }

    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function goBack() {
        window.history.back();
    }

    // 거절 이력 조회
    function viewRejectionHistories() {
        const modal = new bootstrap.Modal(document.getElementById('rejectionHistoryModal'));
        modal.show();

        // API 호출
        fetch(`/v1/admin/members/${memberId}/rejection-histories`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('거절 이력을 불러올 수 없습니다.');
                }
                return response.json();
            })
            .then(data => {
                displayRejectionHistories(data);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('rejectionHistoryContent').innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        거절 이력을 불러오는데 실패했습니다.
                    </div>
                `;
            });
    }

    function displayRejectionHistories(data) {
        const content = document.getElementById('rejectionHistoryContent');

        if (!data.histories || data.histories.length === 0) {
            content.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                    <p class="mt-3 text-muted">거절 이력이 없습니다.</p>
                </div>
            `;
            return;
        }

        // 차수별로 그룹핑
        const groupedByRound = {};
        data.histories.forEach(history => {
            if (!groupedByRound[history.rejectionRound]) {
                groupedByRound[history.rejectionRound] = [];
            }
            groupedByRound[history.rejectionRound].push(history);
        });

        let html = `
            <div class="mb-4">
                <h6 class="text-muted">
                    <i class="bi bi-person me-2"></i>${data.memberName}
                    <span class="badge bg-secondary ms-2">총 ${data.totalRejectionCount}건</span>
                    <span class="badge bg-info ms-2">${data.maxRejectionRound}차 거절</span>
                </h6>
            </div>
        `;

        // 차수별로 역순 정렬 (최신이 위로)
        const rounds = Object.keys(groupedByRound).sort((a, b) => b - a);

        rounds.forEach(round => {
            const histories = groupedByRound[round];
            html += `
                <div class="card mb-3" style="border-radius: 12px;">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="bi bi-calendar-x me-2 text-danger"></i>
                            ${round}차 거절
                            <span class="badge bg-danger ms-2">${histories.length}건</span>
                            <small class="text-muted float-end">${histories[0].rejectedAt}</small>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
            `;

            histories.forEach(history => {
                html += `
                    <div class="col-md-6">
                        <div class="border rounded-3 p-3">
                            <div class="d-flex align-items-start mb-2">
                                <span class="badge ${history.imageType === '얼굴 이미지' ? 'bg-primary' : 'bg-success'} me-2">
                                    ${history.imageType} ${history.imageOrder}
                                </span>
                            </div>
                            <div class="mb-3">
                                <img src="${history.imageUrl}"
                                     class="img-fluid rounded-3 w-100"
                                     style="max-height: 200px; object-fit: cover; cursor: pointer;"
                                     onclick="showImageModal('${history.imageUrl}', '${history.imageType} ${history.imageOrder}')"
                                     alt="${history.imageType}">
                            </div>
                            <div>
                                <strong class="text-danger">거절 사유:</strong>
                                <p class="mb-0 mt-1 text-muted">${history.reason}</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                        </div>
                    </div>
                </div>
            `;
        });

        content.innerHTML = html;
    }

    // 탭 상태 저장/복원
    document.addEventListener('DOMContentLoaded', function() {
        const activeTab = localStorage.getItem('memberDetailActiveTab');
        if (activeTab) {
            const tabElement = document.querySelector(`#${activeTab}`);
            if (tabElement) {
                new bootstrap.Tab(tabElement).show();
            }
        }

        // 탭 클릭 시 상태 저장
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('click', function() {
                localStorage.setItem('memberDetailActiveTab', this.id);
            });
        });
    });

    // 키보드 단축키
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + 숫자로 탭 전환
        if ((e.ctrlKey || e.metaKey) && e.key >= '1' && e.key <= '4') {
            e.preventDefault();
            const tabIndex = parseInt(e.key) - 1;
            const tabs = ['essential-tab', 'personality-tab', 'hidden-tab', 'activity-tab'];
            const targetTab = document.getElementById(tabs[tabIndex]);
            if (targetTab) {
                new bootstrap.Tab(targetTab).show();
            }
        }

        // ESC로 모달 닫기
        if (e.key === 'Escape') {
            const openModals = document.querySelectorAll('.modal.show');
            openModals.forEach(modal => {
                bootstrap.Modal.getInstance(modal)?.hide();
            });
        }
    });
</script>

</body>
</html>
